# Rendering Consistency Standards

This guide captures the enforcement rules, reporting templates, and operator guardrails for the rendering consistency pipeline.

## CI Enforcement

Rendering consistency checks run in `.github/workflows/rendering-consistency.yml`. The workflow executes on Linux, macOS, and Windows and publishes artifacts for every platform.

Key workflow behaviors:

- Installs dependencies with `npm ci`.
- Prints environment context including ffmpeg and Node versions.
- Runs `scripts/check_rendering_consistency.mjs` with platform-aware arguments.
- Uploads the `consistency_out` directory as an artifact for post-run inspection.

## Rendering Consistency Script

The `scripts/check_rendering_consistency.mjs` script performs the following sequence:

1. Renders a five-second preview for the requested project.
2. Captures ffprobe metadata and validates resolution (1920√ó1080), pixel format (`yuv420p`), and sample aspect ratio (`1:1`).
3. Accepts frame rates of `30`, `30/1`, or `30000/1001`.
4. Extracts 30 FPS frames and verifies that exactly 150 ¬±1 frames were produced.
5. Compares the extracted frames to the platform-specific golden frames with FFmpeg SSIM analysis.
6. Requires an average SSIM ‚â• 0.92 to pass and writes a JUnit report.

Artifacts generated by the script include `ffprobe.json`, `frames/`, `ssim.log`, and `junit.xml`.

## JUnit Summary Template

Use the following summary when reporting CI output:

```
üñ• Rendering Consistency Check ‚Äî ${{ runner.os }}

üé• Metadata
- Resolution: 1920√ó1080
- PixFmt: yuv420p
- SAR: 1:1
- FPS: 30

üñº Frame Extraction
- Extracted: 150 ¬±1 frames

üîç SSIM
- Average: <value>
- Threshold: ‚â• 0.95 (soft-pass ‚â• 0.92)

üì¶ Artifacts
- ffprobe.json
- frames/
- ssim.log
- junit.xml
- container.json
```

## Promotion Guardrails

Promotion from preview to golden is allowed only when **all** of the following are true:

1. SSIM ‚â• 0.92.
2. Visual inspection shows no artifacts.
3. FPS, SAR, and pixel format remain unchanged.
4. Render settings are unchanged.
5. The PR includes the operator note: `APPROVED: baseline promotion`.

Promotion command:

```
node scripts/promote_baselines.cjs --game sushi-go --platform macos
```

## SSIM Validator Status Mapping

When integrating SSIM evaluations, apply the status mapping below:

```javascript
if (avgSSIM >= 0.95) status = "PASS";
else if (avgSSIM >= 0.92) status = "SOFT_PASS";
else status = "FAIL";
```

## Triage Log Format

Operators should capture triage findings with the template below for any failing PR:

```
=== TRIAGE REPORT (MOBIUS Rendering Consistency) ===

Platform: macOS | Windows | Linux
Golden game: sushi-go

1. ffprobe checks
- width: 
- height:
- pix_fmt:
- SAR:
- avg_frame_rate:

2. frame count:
- expected 150 (+/-1)
- got: 

3. SSIM:
- avg: 
- threshold: 0.95
- failure frames (if any): 

4. audio:
- integrated_lufs:
- true_peak_dbfs:

5. Notes:
- 

‚úî Director Output Complete
```

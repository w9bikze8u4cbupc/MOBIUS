name: CI â€” Lint / Tests / Playwright / Network Probe

on:
  pull_request:
    branches: [ main, staging ]

jobs:
  lint_and_unit_tests:
    name: Lint & Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install root deps
        run: npm ci

      - name: Lint & format-check
        run: |
          npm run lint --if-present
          npm run format:check --if-present

      - name: Run server unit tests
        env:
          CI: true
        run: npm test --if-present

      - name: Install client deps
        working-directory: ./client
        run: npm ci

      - name: Run client unit tests
        working-directory: ./client
        env:
          CI: true
        run: npm test --if-present

  network_probe:
    name: Network Probe
    runs-on: ubuntu-latest
    needs: lint_and_unit_tests
    steps:
      - uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod +x ./scripts/*.sh

      - name: Run network probe (non-blocking)
        run: |
          echo "Running network probe..."
          ./scripts/network-probe.sh || echo "::warning::Network probe found issues; check logs"
        continue-on-error: true

      - name: Upload probe logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: network-probe-logs
          path: /tmp/network-probe-*.log

  playwright_smoke:
    name: Playwright smoke tests
    runs-on: ubuntu-latest
    needs: [lint_and_unit_tests, network_probe]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Install client deps
        working-directory: ./client
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./client
        run: npx playwright install --with-deps

      - name: Start server and client (background)
        run: |
          npm run start:server &>/tmp/server.log & echo $! > /tmp/server.pid
          (cd client && npm start &>/tmp/client.log & echo $! > /tmp/client.pid)
        env:
          CI: true

      - name: Wait for services
        run: |
          n=0
          until (nc -z localhost 3000 && nc -z localhost 4000) || [ $n -ge 30 ]; do
            n=$((n+1)); sleep 1
          done

      - name: Run Playwright smoke tests
        working-directory: ./client
        env:
          CI: true
        run: npx playwright test --project=chromium --grep @smoke

      - name: Teardown background servers
        if: always()
        run: |
          [ -f /tmp/server.pid ] && kill $(cat /tmp/server.pid) || true
          [ -f /tmp/client.pid ] && kill $(cat /tmp/client.pid) || true
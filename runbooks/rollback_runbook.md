# MOBIUS Rollback Runbook

## Overview

This runbook provides procedures for rolling back deployments when issues are detected.

## When to Rollback

### Automatic Rollback Triggers
- 3 consecutive health check failures
- Application unresponsive for > 90 seconds
- Critical errors in application logs

### Manual Rollback Scenarios
- Performance degradation > 50%
- Data integrity issues detected
- Security vulnerability discovered
- Customer-impacting bugs

## Rollback Procedures

### 1. Immediate Response

**Stop further deployments:**
```bash
# Disable CI/CD pipeline if needed
# Contact team to halt concurrent deployments
```

**Assess situation:**
- Check application logs
- Review monitoring dashboards
- Determine scope of impact

### 2. Automated Rollback

If monitoring is active, rollback may trigger automatically:

```bash
# Check if auto-rollback is running
ps aux | grep monitor.sh

# View rollback progress
tail -f /var/log/rollback.log 2>/dev/null || echo "No rollback log found"
```

### 3. Manual Rollback

If automatic rollback failed or wasn't configured:

```bash
chmod +x scripts/deploy/rollback_dhash.sh
scripts/deploy/rollback_dhash.sh
```

**With specific backup:**
```bash
BACKUP_PATH=backups/backup_20231201_143022 scripts/deploy/rollback_dhash.sh
```

### 4. Rollback Verification

The rollback script automatically runs:
- SHA256 backup integrity verification
- File restoration from backup
- Post-rollback smoke tests  
- 3 consecutive health checks

**Manual verification:**
```bash
# Test health endpoint
curl -s https://your-app.com/health

# Run smoke tests
chmod +x scripts/deploy/smoke_tests.sh
BASE_URL="https://your-app.com" scripts/deploy/smoke_tests.sh

# Check application logs
tail -100 /var/log/application.log
```

## Rollback Types

### Application Code Rollback
- Restores previous application version
- Updates configuration files
- Restarts application services

### Database Rollback
**WARNING:** Database rollbacks are complex and risky.

For schema changes:
1. Use migration rollback scripts if available
2. Restore from database backup if necessary
3. Coordinate with DBA team

### Configuration Rollback
- Restores previous configuration files
- Reloads application configuration
- Validates configuration integrity

## Post-Rollback Actions

### 1. Incident Response

- [ ] Create incident ticket
- [ ] Notify stakeholders
- [ ] Document rollback reason
- [ ] Schedule post-mortem

### 2. System Verification

- [ ] Verify all services healthy
- [ ] Check data integrity
- [ ] Monitor error rates
- [ ] Review performance metrics

### 3. Communication

**Internal notification:**
```bash
node scripts/deploy/notify.js \
  --message "Rollback completed successfully" \
  --severity "info"
```

**Update status page:**
- Customer-facing status updates
- Internal team notifications
- Estimated resolution time

## Rollback Validation Checklist

- [ ] Application responds to health checks
- [ ] Critical user journeys working
- [ ] Database connectivity restored
- [ ] No data corruption detected
- [ ] Error rates returned to baseline
- [ ] Performance metrics normalized

## Troubleshooting Rollback Issues

### Backup Not Found
```bash
# List available backups
ls -la backups/

# Check backup integrity
find backups/ -name "*.sha256" -exec sha256sum -c {} \;
```

### Rollback Script Fails
```bash
# Check script permissions
ls -la scripts/deploy/rollback_dhash.sh

# Review rollback logs
cat /tmp/rollback_$(date +%Y%m%d).log 2>/dev/null

# Manual file restoration
cd backups/backup_YYYYMMDD_HHMMSS
tar -xzf app.tar.gz
tar -xzf config.tar.gz
```

### Services Won't Start
```bash
# Check service status
systemctl status your-app 2>/dev/null || service your-app status

# Review service logs
journalctl -u your-app -n 50 2>/dev/null || tail -50 /var/log/your-app.log

# Restart services manually
systemctl restart your-app 2>/dev/null || service your-app restart
```

## Prevention

### Pre-deployment
- Always create tested backups
- Validate rollback procedures in staging
- Ensure monitoring is configured
- Plan rollback strategy before deployment

### During deployment
- Monitor health metrics continuously
- Have rollback plan ready
- Keep team on standby
- Document any anomalies

## Emergency Contacts

**Immediate Response Team:**
- On-call Engineer: ${ON_CALL_ENGINEER}
- Team Lead: ${TEAM_LEAD}
- SRE: ${SRE_CONTACT}

**Business Stakeholders:**
- Product Manager: ${PRODUCT_MANAGER}
- Customer Success: ${CUSTOMER_SUCCESS}

## Recovery Time Objectives

- **Detection:** < 5 minutes
- **Rollback Decision:** < 10 minutes  
- **Rollback Execution:** < 15 minutes
- **Verification:** < 10 minutes
- **Total RTO:** < 40 minutes

---

*Generated by MOBIUS Deployment Framework*
*Last updated: $(date)*

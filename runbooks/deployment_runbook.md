# MOBIUS Deployment Runbook

## Overview

This runbook provides step-by-step instructions for deploying MOBIUS applications using the automated deployment framework.

## Prerequisites

- [ ] Access to deployment environment
- [ ] Required environment variables set
- [ ] Git repository access
- [ ] Webhook URLs configured (optional, for notifications)

## Pre-Deployment Checklist

- [ ] All tests passing in CI
- [ ] Code review approved
- [ ] No active incidents in production
- [ ] Backup retention verified
- [ ] Deployment window approved

## Deployment Process

### 1. Premerge Validation

Run premerge orchestration to validate environment:

```bash
chmod +x scripts/deploy/premerge_orchestration.sh
scripts/deploy/premerge_orchestration.sh
```

**Expected outputs:**
- Git state validation
- Environment variable checks
- Pre-deployment tests pass

### 2. Create Backup

Create a backup before deployment:

```bash
chmod +x scripts/deploy/backup.sh
scripts/deploy/backup.sh
```

**Expected outputs:**
- Backup created with SHA256 checksums
- Old backups cleaned up (retention: 10)
- Backup path exported to environment

### 3. Deployment Dry Run

Test deployment process without making changes:

```bash
chmod +x scripts/deploy/deploy_dryrun.sh
scripts/deploy/deploy_dryrun.sh
```

**Expected outputs:**
- Configuration validation
- Prerequisite checks
- Deployment simulation log

### 4. Migration Dry Run

Validate database migrations:

```bash
chmod +x scripts/deploy/migration_dryrun.sh
scripts/deploy/migration_dryrun.sh
```

**Expected outputs:**
- Migration file validation
- Database connection test (simulated)
- Migration plan preview

### 5. Execute Deployment

**Note:** Replace this with your actual deployment command

```bash
# Example deployment commands:
# npm run deploy:production
# docker-compose up -d --build
# kubectl apply -f deployment.yaml
echo "Execute your deployment command here"
```

### 6. Post-Deployment Verification

Run smoke tests to verify deployment:

```bash
chmod +x scripts/deploy/smoke_tests.sh
BASE_URL="https://your-app.com" scripts/deploy/smoke_tests.sh
```

**Expected outputs:**
- Health endpoint responds correctly
- Main endpoints accessible
- Application tests pass

### 7. Health Monitoring

Start T+60 monitoring with auto-rollback:

```bash
chmod +x scripts/deploy/monitor.sh
BASE_URL="https://your-app.com" \
MONITOR_DURATION=300 \
FAILURE_THRESHOLD=3 \
AUTO_ROLLBACK=true \
scripts/deploy/monitor.sh
```

**Expected outputs:**
- Continuous health monitoring
- Success rate >= 90%
- Auto-rollback on 3 consecutive failures

## Environment Variables

### Required
- `DEPLOY_ENV`: Deployment environment (staging/production)
- `BASE_URL`: Application base URL for health checks

### Optional
- `BACKUP_DIR`: Backup directory (default: backups)
- `RETENTION_COUNT`: Backup retention count (default: 10)
- `DATABASE_URL`: Database connection string
- `SLACK_WEBHOOK_URL`: Slack webhook for notifications
- `TEAMS_WEBHOOK_URL`: Teams webhook for notifications
- `MONITOR_DURATION`: Monitoring duration in seconds (default: 300)
- `CHECK_INTERVAL`: Health check interval (default: 30)
- `FAILURE_THRESHOLD`: Consecutive failures before rollback (default: 3)

## Troubleshooting

### Common Issues

**Git state validation fails:**
- Ensure working directory is clean
- Commit or stash uncommitted changes

**Health checks fail:**
- Verify BASE_URL is correct
- Check application logs
- Ensure health endpoint returns expected format

**Backup integrity verification fails:**
- Check disk space
- Verify file permissions
- Review backup creation logs

**Auto-rollback triggered:**
- Check application logs for errors
- Verify database connectivity
- Review recent changes

### Emergency Procedures

**Manual rollback required:**
```bash
chmod +x scripts/deploy/rollback_dhash.sh
BACKUP_PATH=/path/to/backup scripts/deploy/rollback_dhash.sh
```

**Export lifecycle data:**
```bash
chmod +x scripts/deploy/lcm_export.sh
scripts/deploy/lcm_export.sh
```

## Support Contacts

- **Primary:** @ops team
- **Secondary:** @media-eng team
- **Escalation:** On-call SRE

## Post-Deployment

- [ ] Verify all services running normally
- [ ] Check monitoring dashboards
- [ ] Update deployment log
- [ ] Notify stakeholders of completion

---

*Generated by MOBIUS Deployment Framework*
*Last updated: $(date)*
